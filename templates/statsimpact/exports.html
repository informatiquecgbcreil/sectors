{% extends "layout.html" %}

{% block body %}
<style>
  .hero{background:linear-gradient(135deg,#0f62fe,#6c5ce7);color:#fff;border-radius:14px;padding:18px 20px;margin:10px auto 16px auto;max-width:980px;box-shadow:0 10px 30px rgba(0,0,0,0.08)}
  .wrap{max-width:980px;margin:0 auto;}
  .card{background:#fff;border-radius:14px;border:1px solid #e6e9ff;box-shadow:0 8px 18px rgba(15,98,254,0.06);padding:14px;margin-bottom:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
  .muted{opacity:.8}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid #dfe3f0;background:#f7f9fc;font-weight:700;cursor:pointer;text-decoration:none;color:#111}
  .btn.ok{background:#16a34a;color:#fff;border-color:#16a34a}
  .btn.blue{background:#0f62fe;color:#fff;border-color:#0f62fe}
  label{font-weight:700;font-size:13px}
  select,input{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #dfe3f0;background:#fff}
  details summary{cursor:pointer;font-weight:800}
  .tag{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;padding:3px 8px;border-radius:999px;font-size:12px}
  .help{font-size:12px;opacity:.75;margin-top:4px}
</style>

<div class="wrap">
  <div class="hero">
    <h1 style="margin:0 0 6px 0;">Stats & Impacts — Exports</h1>
    <div class="muted">Ici on filtre, puis on exporte. Pas 58 boutons, pas 4 formulaires qui se battent. ✌️</div>
  </div>

  <div class="card">
    <form method="get">
      <div class="grid" style="align-items:end;">
        {% if secteurs and secteurs|length > 0 %}
        <div>
          <label>Secteur</label>
          <select name="secteur">
            <option value="">Tous</option>
            {% for s in secteurs %}
              <option value="{{ s }}" {% if flt.secteur==s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        <div>
          <label>Atelier</label>
          <select name="atelier_id">
            <option value="">Tous</option>
            {% for a in ateliers %}
              <option value="{{ a.id }}" {% if flt.atelier_id==a.id %}selected{% endif %}>{{ a.secteur }} — {{ a.nom }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label>Du</label>
          {% set date_from_value = flt.date_from.isoformat() if flt.date_from else "" %}
          <input type="date" name="date_from" value="{{ date_from_value }}">
          <div class="help">Vide = année courante (auto)</div>
        </div>

        <div>
          <label>Au</label>
          {% set date_to_value = flt.date_to.isoformat() if flt.date_to else "" %}
          <input type="date" name="date_to" value="{{ date_to_value }}">
          <div class="help">Vide = année courante (auto)</div>
        </div>

        <div>
          <button class="btn blue" type="submit">Appliquer</button>
        </div>
      </div>

      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <span class="tag">Période : {{ flt.date_from }} → {{ flt.date_to }}</span>
        <span class="tag">Secteur : {{ flt.secteur or "Tous" }}</span>
        <span class="tag">Atelier : {% if flt.atelier_id %}#{{ flt.atelier_id }}{% else %}Tous{% endif %}</span>
        <a class="btn" href="{{ url_for('statsimpact.dashboard') }}?{{ request.query_string.decode('utf-8') }}" style="margin-left:auto;">Ouvrir le dashboard complet</a>
      </div>
    </form>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0;">Exports</h3>
    <div class="muted" style="margin-bottom:10px;">
      Les exports reprennent exactement les filtres ci-dessus.
      <ul style="margin:6px 0 0 16px;">
        <li><b>CSV défaut</b> : 1 ligne = 1 présence (participant × session).</li>
        <li><b>XLSX Magatomatique</b> : synthèse + (optionnel) matrice.</li>
        <li><b>XLSX annuel (1 feuille / atelier)</b> : stats + matrice participants×sessions (avec âge/ville/quartier).</li>
      </ul>
    </div>

    <div class="btnrow">
      <a class="btn ok" href="{{ url_for('statsimpact.magatomatique_export') }}?{{ request.query_string.decode('utf-8') }}">Exporter XLSX (Magatomatique)</a>
      <a class="btn" href="{{ url_for('statsimpact.magatomatique_export') }}?{{ request.query_string.decode('utf-8') }}&export_mode=per_atelier">XLSX annuel (1 feuille / atelier)</a>
      <a class="btn" href="{{ url_for('statsimpact.magatomatique_export_csv') }}?{{ request.query_string.decode('utf-8') }}">Exporter CSV (défaut)</a>
    </div>
  </div>

  <div class="card">
    <details open>
      <summary>CSV sur mesure (optionnel) — tu choisis les colonnes</summary>
      <div class="muted" style="margin-top:6px;">Toujours 1 ligne = 1 présence (participant × session). Si tu veux du tableau matrice : prends le XLSX annuel.</div>

      <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
        <button class="btn" type="button" data-csv-select="all">Tout cocher</button>
        <button class="btn" type="button" data-csv-select="none">Tout décocher</button>
      </div>

      <form method="get" action="{{ url_for('statsimpact.magatomatique_export_csv') }}" style="margin-top:12px;">
        {% if flt.secteur %}<input type="hidden" name="secteur" value="{{ flt.secteur }}">{% endif %}
        {% if flt.atelier_id %}<input type="hidden" name="atelier_id" value="{{ flt.atelier_id }}">{% endif %}
        <input type="hidden" name="date_from" value="{{ flt.date_from or '' }}">
        <input type="hidden" name="date_to" value="{{ flt.date_to or '' }}">

        <div style="display:grid; gap:12px; margin-top:6px;">
          {% for group in csv_field_groups or [] %}
            <div>
              <div style="font-weight:800; margin-bottom:6px;">{{ group.label }}</div>
              <div style="display:flex; flex-wrap:wrap; gap:8px;">
                {% for field in group.fields %}
                  <label class="tag" style="cursor:pointer;">
                    <input type="checkbox" name="fields" value="{{ field.key }}" {% if field.key in csv_default_fields %}checked{% endif %}>
                    {{ field.label }}
                  </label>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>

        <div style="margin-top:12px;">
          <button class="btn blue" type="submit">Exporter CSV sur mesure</button>
        </div>
      </form>
    </details>
  </div>

  <div class="card" style="opacity:.9;">
    <b>Aide rapide</b>
    <div class="muted" style="margin-top:6px;">
      Si tu veux une feuille par atelier avec <i>toutes les sessions en colonnes</i>, et les participants en lignes → <b>XLSX annuel</b>.
      <br>
      Si tu veux du brut à retraiter → <b>CSV défaut</b> ou <b>CSV sur mesure</b>.
    </div>
  </div>
</div>

<script>
(function(){
  const csvButtons = document.querySelectorAll('[data-csv-select]');
  csvButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const mode = btn.getAttribute('data-csv-select');
      const checkboxes = document.querySelectorAll('[name="fields"]');
      checkboxes.forEach(cb => cb.checked = (mode === 'all'));
    });
  });
})();
</script>
{% endblock %}
