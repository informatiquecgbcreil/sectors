{% extends "layout.html" %}

{% block body %}
  {% if forbidden %}
    <div class="card">
      <h1>Bilans & Stats ¬∑ Bilan par secteur</h1>
      <p class="muted">Acc√®s r√©serv√© aux r√¥les finance/direction/responsable de secteur.</p>
    </div>
  {% else %}
    <div class="stack">
      <div class="card">
        <div class="inline" style="justify-content:space-between; flex-wrap:wrap; gap:10px;">
          <div>
            <div class="inline" style="gap:12px; flex-wrap:wrap; align-items:baseline;">
              <h1 style="margin:0;">Bilan par secteur</h1>
              <form method="get" action="{{ url_for('bilans.bilan_secteur') }}" class="inline" style="gap:8px;">
                <label for="year" class="muted">Exercice</label>
                <select id="year" name="year" onchange="this.form.submit()">
                  {% for y in years %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                  {% endfor %}
                </select>
                {% if scope.secteurs is none and selected_secteur %}
                  <input type="hidden" name="secteur" value="{{ selected_secteur }}">
                {% endif %}
                <noscript><button class="btn" type="submit">OK</button></noscript>
              </form>
            </div>
            <p class="muted">
              {% if scope.secteurs is none %}
                Vue multi-secteurs (finance/direction)
              {% else %}
                Ton secteur : {{ scope.secteurs|join(', ') if scope.secteurs else '‚Äî' }}
              {% endif %}
            </p>
          </div>
          <div class="inline" style="gap:8px; flex-wrap:wrap;">
            <a class="btn" href="{{ url_for('bilans.dashboard', year=year) }}">‚Üê Dashboard</a>
            <a class="btn" href="{{ url_for('bilans.bilan_subvention', year=year) }}">üßæ Bilan par subvention</a>
          </div>
        </div>

        {% if scope.secteurs is none %}
          <form method="get" action="{{ url_for('bilans.bilan_secteur') }}" class="inline" style="gap:10px; flex-wrap:wrap; margin-top:10px;">
            <input type="hidden" name="year" value="{{ year }}">
            <label class="muted" for="secteur">Secteur</label>
            <select name="secteur" id="secteur" class="input">
              {% for s in secteurs %}
                <option value="{{ s }}" {% if s == selected_secteur %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
            <button class="btn">Afficher</button>
          </form>
        {% else %}
          <p class="muted" style="margin-top:10px;">Secteur s√©lectionn√© : <strong>{{ selected_secteur }}</strong></p>
        {% endif %}
      </div>

      {% if not data %}
        <div class="card">
          <p class="muted">Aucune donn√©e √† afficher.</p>
        </div>
      {% else %}
        <!-- KPI tiles secteur -->
        <div class="grid two">
          <div class="card">
            <h3>D√©penses engag√©es</h3>
            <h2>{{ '%.2f'|format(data.kpis.depenses) }} ‚Ç¨</h2>
            <p class="muted">D√©penses valid√©es (charges).</p>
          </div>
          <div class="card">
            <h3>Budget disponible</h3>
            <h2>{{ '%.2f'|format(data.kpis.budget) }} ‚Ç¨</h2>
            <p class="muted">Somme des montants r√©els (charges) sur l'ann√©e.</p>
          </div>
          <div class="card">
            <h3>Taux d'ex√©cution</h3>
            <h2>{{ '%.1f'|format(data.kpis.taux_exec) }} %</h2>
            <p class="muted">D√©penses / Budget.</p>
          </div>
          <div class="card">
            <h3>Reste √† engager</h3>
            <h2>{{ '%.2f'|format(data.kpis.reste) }} ‚Ç¨</h2>
            <p class="muted">Budget restant.</p>
          </div>
          <div class="card">
            <h3>√Ä ventiler</h3>
            <h2>{{ '%.2f'|format(data.kpis.a_ventiler) }} ‚Ç¨</h2>
            <p class="muted">Lignes de facture marqu√©es ‚Äú√Ä ventiler‚Äù.</p>
          </div>
          <div class="card">
            <h3>Factures</h3>
            <h2>{{ data.kpis.nb_factures }}</h2>
            <p class="muted">Nombre de factures sur l'ann√©e.</p>
          </div>
        </div>

        <!-- Tableau lignes budg√©taires -->
        <div class="card">
          <h2>Suivi par ligne budg√©taire (charges)</h2>
          {% if data.lignes %}
            <div class="tablewrap">
              <table>
                <thead>
                  <tr>
                    <th>Compte</th>
                    <th>Libell√©</th>
                    <th class="right">Budget r√©el</th>
                    <th class="right">Engag√©</th>
                    <th class="right">Reste</th>
                    <th class="right">Taux</th>
                  </tr>
                </thead>
                <tbody>
                  {% for l in data.lignes %}
                    <tr>
                      <td class="muted">{{ l.compte }}</td>
                      <td><strong>{{ l.libelle }}</strong></td>
                      <td class="right">{{ '%.2f'|format(l.montant_reel) }} ‚Ç¨</td>
                      <td class="right">{{ '%.2f'|format(l.engage) }} ‚Ç¨</td>
                      <td class="right">{{ '%.2f'|format(l.reste) }} ‚Ç¨</td>
                      <td class="right">{{ '%.1f'|format(l.taux) }} %</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="muted">Aucune ligne budg√©taire charge trouv√©e.</p>
          {% endif %}
        </div>

        <!-- Top d√©penses -->
        <div class="card">
          <h2>Top 10 d√©penses</h2>
          {% if data.top_depenses %}
            <div class="tablewrap">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Fournisseur</th>
                    <th>Libell√©</th>
                    <th>R√©f√©rence</th>
                    <th class="right">Montant</th>
                  </tr>
                </thead>
                <tbody>
                  {% for d in data.top_depenses %}
                    <tr>
                      <td class="muted">{{ d.date }}</td>
                      <td>{{ d.fournisseur }}</td>
                      <td><strong>{{ d.libelle }}</strong></td>
                      <td class="muted">{{ d.reference }}</td>
                      <td class="right"><strong>{{ '%.2f'|format(d.montant) }} ‚Ç¨</strong></td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="muted">Aucune d√©pense √† afficher.</p>
          {% endif %}
        </div>
      {% endif %}
    </div>
  {% endif %}
{% endblock %}
