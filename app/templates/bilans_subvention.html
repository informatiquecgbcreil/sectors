{% extends "layout.html" %}

{% block body %}
  {% if forbidden %}
    <div class="card">
      <h1>Bilans & Stats ¬∑ Bilan par subvention</h1>
      <p class="muted">Acc√®s r√©serv√© aux r√¥les finance/direction/responsable de secteur.</p>
    </div>
  {% else %}
    <div class="stack">
      <div class="card">
        <div class="inline" style="justify-content:space-between; flex-wrap:wrap; gap:10px;">
          <div>
            <div class="inline" style="gap:12px; flex-wrap:wrap; align-items:baseline;">
              <h1 style="margin:0;">Bilan par subvention</h1>
              <form method="get" action="{{ url_for('bilans.bilan_subvention') }}" class="inline" style="gap:8px;">
                <label for="year" class="muted">Exercice</label>
                <select id="year" name="year" onchange="this.form.submit()">
                  {% for y in years %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                  {% endfor %}
                </select>
                {% if selected_subvention %}
                  <input type="hidden" name="id" value="{{ selected_subvention.id }}">
                {% endif %}
                <noscript><button class="btn" type="submit">OK</button></noscript>
              </form>
            </div>
            <p class="muted">S√©lectionne une subvention pour afficher un bilan financeur-ready.</p>
          </div>
          <div class="inline" style="gap:8px; flex-wrap:wrap;">
            <a class="btn" href="{{ url_for('bilans.dashboard', year=year) }}">‚Üê Dashboard</a>
            <a class="btn" href="{{ url_for('bilans.bilan_secteur', year=year) }}">üìä Bilan par secteur</a>
          </div>
        </div>

        <form method="get" action="{{ url_for('bilans.bilan_subvention') }}" class="inline" style="gap:10px; flex-wrap:wrap; margin-top:10px;">
          <input type="hidden" name="year" value="{{ year }}">
          <label class="muted" for="id">Subvention</label>
          <select name="id" id="id" class="input" style="min-width:320px;">
            {% for s in subventions %}
              <option value="{{ s.id }}" {% if selected_subvention and s.id == selected_subvention.id %}selected{% endif %}>
                [{{ s.secteur }}] {{ s.nom }} ({{ '%.2f'|format(s.montant_attribue) }} ‚Ç¨)
              </option>
            {% endfor %}
          </select>
          <button class="btn">Afficher</button>
        </form>
      </div>

      {% if not data %}
        <div class="card"><p class="muted">Aucune donn√©e √† afficher.</p></div>
      {% else %}
        <!-- KPI subvention -->
        <div class="grid two">
          <div class="card">
            <h3>Montant accord√©</h3>
            <h2>{{ '%.2f'|format(data.kpis.montant_accorde) }} ‚Ç¨</h2>
            <p class="muted">Montant attribu√© (fallback : budget r√©el des lignes).</p>
          </div>
          <div class="card">
            <h3>D√©penses imput√©es</h3>
            <h2>{{ '%.2f'|format(data.kpis.depenses) }} ‚Ç¨</h2>
            <p class="muted">Somme des d√©penses valid√©es rattach√©es √† cette subvention.</p>
          </div>
          <div class="card">
            <h3>Taux de consommation</h3>
            <h2>{{ '%.1f'|format(data.kpis.taux) }} %</h2>
            <p class="muted">D√©penses / Accord√©.</p>
          </div>
          <div class="card">
            <h3>√âcart</h3>
            <h2>{{ '%.2f'|format(data.kpis.ecart) }} ‚Ç¨</h2>
            <p class="muted">Accord√© - D√©penses.</p>
          </div>
        </div>

        <!-- D√©penses -->
        <div class="card">
          <h2>D√©penses imput√©es</h2>
          {% if data.depenses %}
            <div class="tablewrap">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Fournisseur</th>
                    <th>Libell√©</th>
                    <th>Ligne</th>
                    <th>R√©f√©rence</th>
                    <th class="right">Montant</th>
                  </tr>
                </thead>
                <tbody>
                  {% for d in data.depenses %}
                    <tr>
                      <td class="muted">{{ d.date }}</td>
                      <td>{{ d.fournisseur }}</td>
                      <td><strong>{{ d.libelle }}</strong></td>
                      <td class="muted">{{ d.compte }} ¬∑ {{ d.ligne }}</td>
                      <td class="muted">{{ d.reference }}</td>
                      <td class="right"><strong>{{ '%.2f'|format(d.montant) }} ‚Ç¨</strong></td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="muted">Aucune d√©pense imput√©e.</p>
          {% endif %}
        </div>

        <!-- Mat√©riel -->
        <div class="card">
          <h2>Mat√©riel (inventaire) li√©</h2>
          <p class="muted">Items inventaire cr√©√©s depuis des lignes de facture imput√©es √† cette subvention.</p>
          {% if data.materiel %}
            <div class="tablewrap">
              <table>
                <thead>
                  <tr>
                    <th>ID interne</th>
                    <th>D√©signation</th>
                    <th>√âtat</th>
                    <th>Localisation</th>
                    <th class="right">Valeur</th>
                  </tr>
                </thead>
                <tbody>
                  {% for m in data.materiel %}
                    <tr>
                      <td class="muted">{{ m.id_interne }}</td>
                      <td><strong>{{ m.designation }}</strong></td>
                      <td>{{ m.etat }}</td>
                      <td class="muted">{{ m.localisation }}</td>
                      <td class="right">{% if m.valeur != '' %}{{ '%.2f'|format(m.valeur) }} ‚Ç¨{% endif %}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="muted">Aucun mat√©riel li√©.</p>
          {% endif %}
        </div>
      {% endif %}
    </div>
  {% endif %}
{% endblock %}
