{% extends "layout.html" %}
{% block body %}
<div class="stack">

  <div class="card">
    {% include "_projet_budget_header.html" %}
  </div>

  {# ===== KPI / SYNTH√àSE PRODUITS ===== #}
  {% set total_demande = (budget_stats.total_demande or 0) if budget_stats is defined else 0 %}
  {% set total_accorde = (budget_stats.total_accorde or 0) if budget_stats is defined else 0 %}
  {% set total_recu = (budget_stats.total_recu or 0) if budget_stats is defined else 0 %}
  {% set total_charges = (budget_stats.total_charges or 0) if budget_stats is defined else 0 %}

  {% set pct_accorde_sur_charges = (total_accorde / total_charges * 100) if total_charges else 0 %}
  {% set pct_recu_sur_accorde = (total_recu / total_accorde * 100) if total_accorde else 0 %}
  {% set reste_a_securiser = (total_charges - total_accorde) if total_charges else 0 %}
  {% if reste_a_securiser < 0 %}{% set reste_a_securiser = 0 %}{% endif %}
  {% set pct_reste = (reste_a_securiser / total_charges * 100) if total_charges else 0 %}

  <div class="card">
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Produits demand√©s</div>
        <div class="kpi-value">{{ "%.2f"|format(total_demande) }}‚Ç¨</div>
        <div class="kpi-help">Montants sollicit√©s (intention).</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Produits accord√©s</div>
        <div class="kpi-value">{{ "%.2f"|format(total_accorde) }}‚Ç¨</div>
        <div class="kpi-help">S√©curis√© √† date.</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Produits re√ßus</div>
        <div class="kpi-value">{{ "%.2f"|format(total_recu) }}‚Ç¨</div>
        <div class="kpi-help">Cash r√©ellement encaiss√©.</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Taux de s√©curisation</div>
        <div class="kpi-value">{{ "%.0f"|format(pct_accorde_sur_charges) }}%</div>
        <div class="kpi-help">Accord√© / charges pr√©visionnelles.</div>
      </div>
    </div>

    <div class="budget-section" style="padding:0; margin-top:12px;">
      <div class="kpi-label">S√©curis√© vs √† s√©curiser</div>
      <div class="meter">
        {% set pct_couvert = pct_accorde_sur_charges %}
        <div class="meter__fill meter__fill--ok" style="width:{{ pct_couvert }}%;"></div>
      </div>
      <div class="legend">
        <span><strong class="mono">{{ "%.2f"|format(total_accorde) }}‚Ç¨</strong> s√©curis√©</span>
        <span><strong class="mono">{{ "%.2f"|format(reste_a_securiser) }}‚Ç¨</strong> √† s√©curiser ({{ "%.0f"|format(pct_reste) }}%)</span>
        {% if total_accorde %}
          <span><strong class="mono">{{ "%.0f"|format(pct_recu_sur_accorde) }}%</strong> encaiss√© (re√ßu/accord√©)</span>
        {% endif %}
      </div>
    </div>
  </div>

  {# ===== ALERTES ‚Äúproduits‚Äù (simple, actionnable) ===== #}
  {% set nb_reste_ventiler = 0 %}
  {% set nb_non_recu = 0 %}
  {% set nb_refuse = 0 %}
  {% for p in produits %}
    {% if (p.reste_a_ventiler or 0) > 0 %}{% set nb_reste_ventiler = nb_reste_ventiler + 1 %}{% endif %}
    {% if (p.montant_accorde or 0) > 0 and (p.montant_recu or 0) == 0 %}{% set nb_non_recu = nb_non_recu + 1 %}{% endif %}
    {% if (p.statut or '') == 'refuse' %}{% set nb_refuse = nb_refuse + 1 %}{% endif %}
  {% endfor %}

  <div class="card callout">
    <div class="callout__title">√Ä surveiller</div>
    <ul class="watch-list">
      {% if nb_reste_ventiler %}
        <li>{{ nb_reste_ventiler }} financeur(s) ont un reste √† ventiler.</li>
      {% endif %}
      {% if nb_non_recu %}
        <li>{{ nb_non_recu }} financeur(s) accord√©(s) mais pas encore re√ßu(s).</li>
      {% endif %}
      {% if nb_refuse %}
        <li>{{ nb_refuse }} financeur(s) refus√©(s) (√† requalifier / remplacer).</li>
      {% endif %}
      {% if not nb_reste_ventiler and not nb_non_recu and not nb_refuse %}
        <li class="muted">Rien √† signaler. Pour une fois, c‚Äôest reposant.</li>
      {% endif %}
    </ul>
  </div>

  {# ===== FORM AJOUT PRODUIT ===== #}
  <div class="card">
    <div class="section-title">Ajouter un financeur / produit</div>

    <form method="post" class="form-grid">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <div class="field">
        <label>Financeur</label>
        <input name="financeur" placeholder="Ex: CAF Oise" required>
      </div>

      <div class="field">
        <label>Cat√©gorie</label>
        <select name="categorie">
          <option value="etat">√âtat</option>
          <option value="region">R√©gion</option>
          <option value="departement">D√©partement</option>
          <option value="commune">Commune / Agglo</option>
          <option value="caf">CAF</option>
          <option value="europe">Europe</option>
          <option value="prive">Priv√© / Fondation</option>
          <option value="autofinancement">Autofinancement</option>
          <option value="vente_presta">Vente / presta</option>
          <option value="autre" selected>Autre</option>
        </select>
      </div>

      <div class="field">
        <label>Statut</label>
        <select name="statut">
          <option value="prevu">Pr√©vu</option>
          <option value="demande">Demand√©</option>
          <option value="accorde">Accord√©</option>
          <option value="partiel">Partiel</option>
          <option value="refuse">Refus√©</option>
        </select>
      </div>

      <div class="field">
        <label>Demand√© (‚Ç¨)</label>
        <input name="montant_demande" type="number" step="0.01" placeholder="0.00">
      </div>

      <div class="field">
        <label>Accord√© (‚Ç¨)</label>
        <input name="montant_accorde" type="number" step="0.01" placeholder="0.00">
      </div>

      <div class="field">
        <label>Re√ßu (‚Ç¨)</label>
        <input name="montant_recu" type="number" step="0.01" placeholder="0.00">
      </div>

      <div class="field">
        <label>R√©f√©rence dossier (option)</label>
        <input name="reference_dossier" placeholder="Ex: 2026-CAF-123">
      </div>

      <div class="field field--wide">
        <label>Commentaire (option)</label>
        <input name="commentaire" placeholder="Notes‚Ä¶">
      </div>

      <div class="field field--actions">
        <button class="btn ok" type="submit">Ajouter</button>
      </div>
    </form>
  </div>

  {# ===== TABLE PRODUITS ===== #}
  <div class="card">
    <div class="tablewrap">
      <table>
        <thead>
          <tr>
            <th>Financeur</th>
            <th>Cat√©gorie</th>
            <th>Statut</th>
            <th class="num">Demand√©</th>
            <th class="num">Accord√©</th>
            <th class="num">Re√ßu</th>
            <th class="num">Ventil√©</th>
            <th class="num">Reste √† ventiler</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
        {% for p in produits %}
          {% set d = (p.montant_demande or 0) %}
          {% set a = (p.montant_accorde or 0) %}
          {% set r = (p.montant_recu or 0) %}
          {% set v = (p.ventile or 0) %}
          {% set rv = (p.reste_a_ventiler or 0) %}
          {% set pct_v = (v / a * 100) if a else (v / d * 100 if d else 0) %}

          {% set statut = (p.statut or 'prevu') %}
          {% set pill_class = 'pill' %}
          {% if statut == 'accorde' %}
            {% set pill_class = 'pill pill--ok' %}
          {% elif statut == 'partiel' or statut == 'demande' %}
            {% set pill_class = 'pill pill--warn' %}
          {% elif statut == 'refuse' %}
            {% set pill_class = 'pill pill--danger' %}
          {% endif %}

          <tr>
            <td><strong>{{ p.financeur }}</strong></td>
            <td class="muted">{{ p.categorie }}</td>
            <td><span class="{{ pill_class }}">{{ p.statut }}</span></td>

            <td class="num"><span class="mono">{{ "%.2f"|format(d) }}‚Ç¨</span></td>
            <td class="num"><span class="mono">{{ "%.2f"|format(a) }}‚Ç¨</span></td>
            <td class="num"><span class="mono">{{ "%.2f"|format(r) }}‚Ç¨</span></td>

            <td class="num">
              <div class="cell-money">
                <div class="cell-money__main mono">{{ "%.2f"|format(v) }}‚Ç¨</div>
                <div class="meter meter--thin" style="width:140px;">
                  <div class="meter__fill" style="width:{{ pct_v }}%;"></div>
                </div>
                <div class="cell-money__sub muted">{{ "%.0f"|format(pct_v) }}% ventil√©</div>
              </div>
            </td>

            <td class="num">
              {% if rv == 0 %}
                <span class="pill pill--ok">0.00‚Ç¨</span>
              {% elif rv < 250 %}
                <span class="pill pill--warn">{{ "%.2f"|format(rv) }}‚Ç¨</span>
              {% else %}
                <span class="pill pill--danger">{{ "%.2f"|format(rv) }}‚Ç¨</span>
              {% endif %}
            </td>

            <td class="actions" style="white-space:nowrap">
              <a class="btn" href="{{ url_for('projets.projet_budget_produit_edit', projet_id=projet.id, produit_id=p.id) }}">‚úèÔ∏è</a>
              <form method="post" action="{{ url_for('projets.projet_budget_produit_delete', projet_id=projet.id, produit_id=p.id) }}" style="display:inline" onsubmit="return confirm('Supprimer ce produit/financeur ?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn" type="submit">üóëÔ∏è</button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="9" class="muted">Aucun produit/financeur pour le moment.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}
