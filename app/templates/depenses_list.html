{% extends "layout.html" %}
{% block body %}

<div class="stack">
  <div class="card">
    <div class="card-header">
      <div>
        <h1 class="card-title">Dépenses</h1>
        <p class="card-subtitle">Ici tu retrouves toutes les dépenses visibles selon ton rôle.</p>
      </div>
      <div class="inline">
        <a class="btn ok" href="{{ url_for('budget.depense_new') }}">Nouvelle dépense</a>
      </div>
    </div>

    {% set totals = namespace(depenses=0) %}
    {% for d in deps %}
      {% set totals.depenses = totals.depenses + (d.montant or 0) %}
    {% endfor %}
    {% set total_depenses = totals.depenses %}
    {% set nb_depenses = deps|length %}
    {% set avg_depense = (total_depenses / nb_depenses) if nb_depenses else 0 %}

    <div class="spacer"></div>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="muted">Total filtré</div>
        <div class="kpi-value">{{ "%.2f"|format(total_depenses or 0) }}€</div>
      </div>
      <div class="kpi-card">
        <div class="muted">Nombre de dépenses</div>
        <div class="kpi-value">{{ nb_depenses }}</div>
      </div>
      <div class="kpi-card">
        <div class="muted">Moyenne</div>
        <div class="kpi-value">{{ "%.2f"|format(avg_depense) }}€</div>
      </div>
    </div>

    <div class="spacer"></div>
    <form method="GET" class="grid two">
      <div>
        <label>Subvention</label>
        <select name="subvention_id" onchange="this.form.submit()">
          <option value="">-- toutes --</option>
          {% for s in subs %}
            <option value="{{ s.id }}" {% if selected_sub_id == s.id %}selected{% endif %}>
              {{ s.annee_exercice }} · {{ s.secteur }} · {{ s.nom }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label>Ligne (si subvention sélectionnée)</label>
        <select name="ligne_budget_id" onchange="this.form.submit()">
          <option value="">-- toutes --</option>
          {% for l in lignes %}
            <option value="{{ l.id }}" {% if selected_ligne_id == l.id %}selected{% endif %}>
              {{ l.compte }} · {{ l.libelle }}
            </option>
          {% endfor %}
        </select>
      </div>

      <noscript><button class="btn ok" type="submit">Filtrer</button></noscript>
    </form>
  </div>

  <div class="card">
    <h2>Liste</h2>
    <p class="muted">Clique sur une dépense pour la modifier ou ajuster son justificatif.</p>

    <div class="tablewrap">
      <table>
        <thead>
          <tr>
            <th>Subvention</th>
            <th>Ligne</th>
            <th>Dépense</th>
            <th>Montant</th>
            <th>Date</th>
            <th>Type</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% if deps and deps|length %}
            {% for d in deps %}
              {% set l = d.budget_source %}
              {% set s = l.source_sub %}
              <tr>
                <td><strong>{{ s.nom }}</strong><div class="muted">{{ s.secteur }} · {{ s.annee_exercice }}</div></td>
                <td>{{ l.compte }} · <span class="muted">{{ l.libelle }}</span></td>
                <td><strong>{{ d.libelle }}</strong></td>
                <td>{{ "%.2f"|format(d.montant or 0) }}€</td>
                <td class="muted">{{ d.date_paiement or "" }}</td>
                <td class="muted">{{ d.type_depense or "" }}</td>
                <td class="inline">
                  <a class="btn" href="{{ url_for('budget.depense_edit', depense_id=d.id) }}">Éditer</a>

                  {# Suppression via endpoint dédié (évite un 400 sur depense_edit) #}
                  {% if can("depenses:delete") %}
                    <form method="POST" action="{{ url_for('budget.depense_delete', depense_id=d.id) }}" style="display:inline;">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn danger" type="submit" onclick="return confirm('Supprimer cette dépense ?');">Supprimer</button>
                    </form>
                  {% endif %}

                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="7" class="muted">Aucune dépense pour les filtres sélectionnés.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}
