{% extends "layout.html" %}

{% block body %}
<div class="container" style="max-width: 1100px;">

  <div class="card" style="margin-top:18px;">
    <div class="card-header" style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
      <div>
        <h2 class="card-title" style="margin:0;">Pilotage subvention</h2>
        <p class="card-subtitle" style="margin:6px 0 0 0;">
          <strong>{{ sub.financeur }}</strong> — Secteur : <strong>{{ sub.secteur }}</strong>
          {% if sub.annee %} — Année : <strong>{{ sub.annee }}</strong>{% endif %}
        </p>
      </div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <a class="btn" href="{{ url_for('main.subventions_list') }}">← Retour liste</a>
        <a class="btn" href="{{ url_for('main.subvention_bilan', subvention_id=sub.id) }}">Bilan</a>
        <form method="POST" action="{{ url_for('main.subvention_delete', subvention_id=sub.id) }}" style="margin:0;" onsubmit="return confirm('Supprimer cette subvention ?');">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="btn danger" type="submit">Supprimer</button>
        </form>
      </div>
    </div>

    {% if warnings and warnings|length %}
      <div style="padding:0 16px 16px 16px;">
        <div class="card" style="border-color: color-mix(in srgb, var(--warn) 55%, var(--border)); background: color-mix(in srgb, var(--warn) 10%, transparent);">
          <div class="card-header">
            <h3 class="card-title" style="margin:0;">À surveiller</h3>
          </div>
          <div style="padding: 0 16px 16px 16px;">
            <ul style="margin:0; padding-left:18px;">
              {% for w in warnings %}<li>{{ w }}</li>{% endfor %}
            </ul>
          </div>
        </div>
      </div>
    {% endif %}

    <div style="padding: 0 16px 16px 16px;">
      <div class="cards" style="grid-template-columns: repeat(4, minmax(220px, 1fr));">
        <div class="card">
          <div class="card-header"><h3 class="card-title">Demandé</h3></div>
          <div style="padding: 0 16px 16px 16px; font-size:20px; font-weight:800;">{{ (sub.montant_demande or 0)|float|round(2) }}€</div>
        </div>
        <div class="card">
          <div class="card-header"><h3 class="card-title">Attribué</h3></div>
          <div style="padding: 0 16px 16px 16px; font-size:20px; font-weight:800;">{{ (sub.montant_attribue or 0)|float|round(2) }}€</div>
        </div>
        <div class="card">
          <div class="card-header"><h3 class="card-title">Reçu</h3></div>
          <div style="padding: 0 16px 16px 16px; font-size:20px; font-weight:800;">{{ (sub.montant_recu or 0)|float|round(2) }}€</div>
        </div>
        <div class="card">
          <div class="card-header"><h3 class="card-title">Base lignes</h3></div>
          <div style="padding: 0 16px 16px 16px; font-size:20px; font-weight:800;">{{ (total_base or 0)|float|round(2) }}€</div>
        </div>
      </div>
    </div>

    <div style="padding: 0 16px 18px 16px;">
      <div class="card">
        <div class="card-header"><h3 class="card-title" style="margin:0;">Mettre à jour les montants globaux</h3></div>
        <div style="padding: 0 16px 16px 16px;">
          <form method="POST" action="{{ url_for('main.subvention_pilotage', subvention_id=sub.id) }}" style="display:grid; grid-template-columns: repeat(4, minmax(180px, 1fr)); gap:10px; align-items:end;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="update_montants">

            <label>
              <div style="font-size:12px; color:var(--muted); font-weight:700;">Demandé (€)</div>
              <input name="montant_demande" type="number" step="0.01" value="{{ (sub.montant_demande or 0)|float }}" style="width:100%;">
            </label>
            <label>
              <div style="font-size:12px; color:var(--muted); font-weight:700;">Attribué (€)</div>
              <input name="montant_attribue" type="number" step="0.01" value="{{ (sub.montant_attribue or 0)|float }}" style="width:100%;">
            </label>
            <label>
              <div style="font-size:12px; color:var(--muted); font-weight:700;">Reçu (€)</div>
              <input name="montant_recu" type="number" step="0.01" value="{{ (sub.montant_recu or 0)|float }}" style="width:100%;">
            </label>
            <button class="btn ok" type="submit">Enregistrer</button>
          </form>
        </div>
      </div>
    </div>

    <div style="padding: 0 16px 18px 16px;">
      <div class="cards" style="grid-template-columns: 1fr 1fr;">
        <div class="card">
          <div class="card-header"><h3 class="card-title" style="margin:0;">Lier à des projets</h3></div>
          <div style="padding: 0 16px 16px 16px;">
            <div class="tablewrap">
              <table>
                <thead>
                  <tr>
                    <th>Projet</th>
                    <th style="width:120px;">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for p in projets %}
                    <tr>
                      <td>{{ p.nom }}</td>
                      <td>
                        <form method="POST" action="{{ url_for('main.subvention_toggle_projet', subvention_id=sub.id) }}" style="margin:0;">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="projet_id" value="{{ p.id }}">
                          {% if p.id in linked_ids %}
                            <button class="btn warn" type="submit">Délier</button>
                          {% else %}
                            <button class="btn ok" type="submit">Lier</button>
                          {% endif %}
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><h3 class="card-title" style="margin:0;">Ventilation automatique</h3></div>
          <div style="padding: 0 16px 16px 16px; display:flex; flex-direction:column; gap:10px;">

            <div style="font-size:13px; color:var(--muted);">
              Écrit dans <strong>montant réel</strong> de chaque ligne. Modes : copier base, pro-rata (sur reçu ou attribué), reset.
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <form method="POST" action="{{ url_for('main.subvention_pilotage', subvention_id=sub.id) }}" style="margin:0;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="auto_ventilation">
                <input type="hidden" name="mode" value="copy_base">
                <input type="hidden" name="target" value="recu">
                <button class="btn" type="submit">Copier base → réel</button>
              </form>

              <form method="POST" action="{{ url_for('main.subvention_pilotage', subvention_id=sub.id) }}" style="margin:0;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="auto_ventilation">
                <input type="hidden" name="mode" value="prorata_base">
                <input type="hidden" name="target" value="recu">
                <button class="btn ok" type="submit">Appliquer au prorata (reçu)</button>
              </form>

              <form method="POST" action="{{ url_for('main.subvention_pilotage', subvention_id=sub.id) }}" style="margin:0;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="auto_ventilation">
                <input type="hidden" name="mode" value="prorata_base">
                <input type="hidden" name="target" value="attribue">
                <button class="btn" type="submit">Prorata (attribué)</button>
              </form>

              <form method="POST" action="{{ url_for('main.subvention_pilotage', subvention_id=sub.id) }}" style="margin:0;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="auto_ventilation">
                <input type="hidden" name="mode" value="reset">
                <input type="hidden" name="target" value="recu">
                <button class="btn danger" type="submit">Reset réel</button>
              </form>
            </div>

            <div class="card" style="padding: 12px 14px; background: color-mix(in srgb, var(--surface) 92%, transparent);">
              <div style="font-size:12px; color:var(--muted); font-weight:700;">Théorie (aperçu)</div>
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:8px;">
                <div>
                  <div style="font-weight:800;">Reçu</div>
                  <div style="font-size:12px; color:var(--muted);">Pro-rata sur {{ (sub.montant_recu or 0)|float|round(2) }}€</div>
                </div>
                <div>
                  <div style="font-weight:800;">Attribué</div>
                  <div style="font-size:12px; color:var(--muted);">Pro-rata sur {{ (sub.montant_attribue or 0)|float|round(2) }}€</div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <div style="padding: 0 16px 18px 16px;">
      <div class="card">
        <div class="card-header"><h3 class="card-title" style="margin:0;">Ajouter une ligne (charge / produit)</h3></div>
        <div style="padding: 0 16px 16px 16px;">
          <form method="POST" action="{{ url_for('main.subvention_pilotage', subvention_id=sub.id) }}" style="display:grid; grid-template-columns: 110px 1fr 150px 150px 160px 140px; gap:10px; align-items:end;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="add_ligne">

            <label>
              <div style="font-size:12px; color:var(--muted); font-weight:700;">Compte</div>
              <input name="compte" value="60" style="width:100%;">
            </label>

            <label>
              <div style="font-size:12px; color:var(--muted); font-weight:700;">Libellé</div>
              <input name="libelle" placeholder="ex: Prestation / Achat / Participation..." style="width:100%;">
            </label>

            <label>
              <div style="font-size:12px; color:var(--muted); font-weight:700;">Base (€)</div>
              <input name="montant_base" type="number" step="0.01" value="0" style="width:100%;">
            </label>

            <label>
              <div style="font-size:12px; color:var(--muted); font-weight:700;">Réel (€)</div>
              <input name="montant_reel" type="number" step="0.01" value="0" style="width:100%;">
            </label>

            <label>
              <div style="font-size:12px; color:var(--muted); font-weight:700;">Nature</div>
              <select name="nature" style="width:100%;">
                <option value="charge" selected>Charge</option>
                <option value="produit">Produit</option>
              </select>
            </label>

            <button class="btn ok" type="submit">Ajouter</button>
          </form>
        </div>
      </div>
    </div>

    <div style="padding: 0 16px 18px 16px;">
      <div class="card">
        <div class="card-header"><h3 class="card-title" style="margin:0;">Lignes</h3></div>
        <div style="padding: 0 16px 16px 16px;">
          <div class="tablewrap">
            <table>
              <thead>
                <tr>
                  <th>Nature</th>
                  <th>Compte</th>
                  <th>Libellé</th>
                  <th style="text-align:right;">Base</th>
                  <th style="text-align:right;">Réel</th>
                  <th style="width:260px;">Actions</th>
                </tr>
              </thead>
              <tbody>
              {% for l in sub.lignes %}
                <tr>
                  <td>
                    <span class="pill">{{ (l.nature or 'charge') }}</span>
                  </td>
                  <td>{{ l.compte }}</td>
                  <td>{{ l.libelle }}</td>
                  <td style="text-align:right;">{{ (l.montant_base or 0)|float|round(2) }}€</td>
                  <td style="text-align:right;">{{ (l.montant_reel or 0)|float|round(2) }}€</td>
                  <td>
                    <form method="POST" action="{{ url_for('main.ligne_edit', ligne_id=l.id) }}" style="display:grid; grid-template-columns: 120px 1fr 120px 120px 120px; gap:8px; align-items:end;">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                      <select name="nature">
                        <option value="charge" {% if (l.nature or 'charge') == 'charge' %}selected{% endif %}>charge</option>
                        <option value="produit" {% if (l.nature or '') == 'produit' %}selected{% endif %}>produit</option>
                      </select>
                      <input name="libelle" value="{{ l.libelle }}">
                      <input name="compte" value="{{ l.compte }}">
                      <input name="montant_base" type="number" step="0.01" value="{{ (l.montant_base or 0)|float }}">
                      <input name="montant_reel" type="number" step="0.01" value="{{ (l.montant_reel or 0)|float }}">

                      <div style="grid-column:1 / -1; display:flex; gap:8px; justify-content:flex-end;">
                        <button class="btn" type="submit">Enregistrer</button>
                        <form method="POST" action="{{ url_for('main.ligne_delete', ligne_id=l.id) }}" style="margin:0;" onsubmit="return confirm('Supprimer cette ligne ?');">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <button class="btn danger" type="submit">Supprimer</button>
                        </form>
                      </div>
                    </form>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}
