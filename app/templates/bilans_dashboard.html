{% extends "layout.html" %}

{% block body %}
  {% if forbidden %}
    <div class="card">
      <h1>Bilans & Stats</h1>
      <p class="muted">Acc√®s r√©serv√© aux r√¥les finance/direction/responsable de secteur.</p>
    </div>
  {% else %}
    <div class="stack">
      <div class="card">
        <div class="inline" style="justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
          <h1 style="margin:0;">Bilans & Stats</h1>

          <form method="get" action="{{ url_for('bilans.dashboard') }}" class="inline" style="gap:8px;">
            <label for="year" class="muted">Exercice</label>
            <select id="year" name="year" onchange="this.form.submit()">
              {% for y in years %}
                <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>
            <noscript><button class="btn" type="submit">OK</button></noscript>
          </form>
        </div>
        <p class="muted">
          {% if scope.secteurs is none %}
            Vue globale (tous secteurs)
          {% else %}
            P√©rim√®tre : {{ scope.secteurs|join(', ') if scope.secteurs else '‚Äî' }}
          {% endif %}
        </p>

        <div class="inline" style="gap:8px; flex-wrap:wrap; margin-top:10px;">
          <a class="btn" href="{{ url_for('bilans.bilan_secteur', year=year) }}">üìä Bilan par secteur</a>
          <a class="btn" href="{{ url_for('bilans.bilan_subvention', year=year) }}">üßæ Bilan par subvention</a>
          <a class="btn" href="{{ url_for('bilans.qualite', year=year) }}">üßπ Qualit√© de gestion</a>
          <a class="btn" href="{{ url_for('bilans.inventaire', year=year) }}">üì¶ Inventaire</a>
          {% if has_perm("bilans:view") %}
          <a class="btn" href="{{ url_for('bilans.bilans_lourds', year=year) }}">üß† Bilans lourds</a>
          {% endif %}
        </div>
      </div>

      <!-- KPI tiles -->
      <div class="grid two">
        <div class="card">
          <h3>D√©penses engag√©es</h3>
          <h2>{{ '%.2f'|format(kpis.depenses) }} ‚Ç¨</h2>
          <p class="muted">D√©penses valid√©es (charges) sur l'ann√©e.</p>
        </div>
        <div class="card">
          <h3>Budget total disponible</h3>
          <h2>{{ '%.2f'|format(kpis.budget) }} ‚Ç¨</h2>
          <p class="muted">Somme des montants r√©els (lignes charges) des subventions.</p>
        </div>
        <div class="card">
          <h3>Taux d'ex√©cution</h3>
          <h2>{{ '%.1f'|format(kpis.taux_exec) }} %</h2>
          <p class="muted">D√©penses / Budget.</p>
        </div>
        <div class="card">
          <h3>Reste √† engager</h3>
          <h2>{{ '%.2f'|format(kpis.reste) }} ‚Ç¨</h2>
          <p class="muted">Budget restant sur l'ann√©e.</p>
        </div>
        <div class="card">
          <h3>√Ä ventiler</h3>
          <h2>{{ '%.2f'|format(kpis.a_ventiler) }} ‚Ç¨</h2>
          <p class="muted">Lignes de facture marqu√©es ‚Äú√Ä ventiler‚Äù.</p>
        </div>
        <div class="card">
          <h3>Factures</h3>
          <h2>{{ kpis.nb_factures }}</h2>
          <p class="muted">Nombre de factures (date facture) sur l'ann√©e.</p>
        </div>
      </div>

      <!-- Depenses mensuelles -->
      <div class="card">
        <h2>√âvolution mensuelle des d√©penses</h2>
        <p class="muted">Bas√© sur la date de facture lorsque disponible.</p>

        {% set maxv = (series|max(attribute='total')).total if series else 0 %}

        <div class="stack">
          {% for row in series %}
            {% set pct = (row.total / maxv * 100) if maxv and row.total else 0 %}
            <div>
              <div class="inline" style="justify-content:space-between;">
                <div class="muted">{{ '%02d'|format(row.mois) }}/{{ year }}</div>
                <div><strong>{{ '%.2f'|format(row.total) }} ‚Ç¨</strong></div>
              </div>
              <div style="height:10px;border-radius:999px;background:var(--surface-soft);overflow:hidden;border:1px solid var(--border);">
                <div style="height:10px;width:{{ pct }}%;background:var(--accent);"></div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- R√©partition par secteur -->
      <div class="card">
        <h2>R√©partition des d√©penses par secteur</h2>
        {% if not multi_secteurs %}
          <p class="muted">Vue limit√©e √† ton secteur.</p>
        {% endif %}

        {% set maxs = (par_secteur|max(attribute='total')).total if par_secteur else 0 %}

        {% if par_secteur %}
          <div class="stack">
            {% for s in par_secteur %}
              {% set pct = (s.total / maxs * 100) if maxs and s.total else 0 %}
              <div>
                <div class="inline" style="justify-content:space-between;">
                  <div><strong>{{ s.secteur }}</strong></div>
                  <div class="muted">{{ '%.2f'|format(s.total) }} ‚Ç¨</div>
                </div>
                <div style="height:10px;border-radius:999px;background:var(--surface-soft);overflow:hidden;border:1px solid var(--border);">
                  <div style="height:10px;width:{{ pct }}%;background:var(--ok);"></div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="muted">Aucune d√©pense √† afficher.</p>
        {% endif %}
      </div>

      <!-- Alertes -->
      <div class="card">
        <h2>Alertes (aide √† la gestion)</h2>
        {% if alertes %}
          <div class="tablewrap">
            <table>
              <thead>
                <tr>
                  <th>Niveau</th>
                  <th>Titre</th>
                  <th>D√©tail</th>
                </tr>
              </thead>
              <tbody>
                {% for a in alertes %}
                  <tr>
                    <td>
                      {% if a.niveau == 'danger' %}
                        <span class="btn danger">üî¥</span>
                      {% elif a.niveau == 'warn' %}
                        <span class="btn warn">üü†</span>
                      {% else %}
                        <span class="btn">‚ÑπÔ∏è</span>
                      {% endif %}
                    </td>
                    <td><strong>{{ a.titre }}</strong></td>
                    <td class="muted">{{ a.detail }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="muted">Aucune alerte. (Oui, √ßa arrive.)</p>
        {% endif %}
      </div>
    </div>
  {% endif %}
{% endblock %}
